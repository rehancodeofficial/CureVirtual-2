generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =========================================================
// ENUMS
// =========================================================

enum UserRole {
  DOCTOR
  PATIENT
  PHARMACY
  SUPERADMIN
  ADMIN
  SUPPORT
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum BloodGroup {
  A_POSITIVE  @map("A+")
  A_NEGATIVE  @map("A-")
  B_POSITIVE  @map("B+")
  B_NEGATIVE  @map("B-")
  AB_POSITIVE @map("AB+")
  AB_NEGATIVE @map("AB-")
  O_POSITIVE  @map("O+")
  O_NEGATIVE  @map("O-")
  UNKNOWN     @map("UNKNOWN")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum ConsultationStatus {
  SCHEDULED
  CHECKED_IN
  WAITING
  ONGOING
  COMPLETED
  CANCELLED
}

enum AppointmentStatus {
  PENDING
  APPROVED
  CHECKED_IN
  WAITING
  IN_SESSION
  COMPLETED
  CANCELLED
  SCHEDULED
  NO_SHOW
}

enum Plan {
  MONTHLY
  YEARLY
}

enum SubStatus {
  UNSUBSCRIBED
  PENDING
  ACTIVE
  EXPIRED
  DEACTIVATED
  FAILED
}

enum PrescriptionDispatchStatus {
  NONE
  SENT
  ACKNOWLEDGED
  READY
  DISPENSED
  REJECTED
}

enum EncounterStatus {
  DRAFT
  SIGNED
  AMENDED
}

enum LabStatus {
  ORDERED
  PENDING
  COMPLETED
  CANCELLED
}

enum ReferralType {
  INTERNAL
  EXTERNAL
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  LOCKED
  CANCELLED
}

// =========================================================
// MODELS
// =========================================================



model User {
  id          String   @id @default(uuid())
  firstName   String
  middleName  String?
  lastName    String
  email       String   @unique
  phone       String?
  password    String?  // Made optional - Supabase manages passwords
  role        UserRole @default(PATIENT)
  dateOfBirth DateTime
  gender      Gender

  subscriptionState SubStatus @default(UNSUBSCRIBED)

  subscriptions Subscription[]
  doctor        DoctorProfile?
  patient       PatientProfile?
  pharmacy      PharmacyProfile?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  sentMessages  Message[] @relation("MessagesSent")
  recvMessages  Message[] @relation("MessagesRecv")

  supportAgent  SupportAgent?
  raisedTickets SupportTicket[] @relation("raisedBy")
  sentReplies   SupportReply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions    Transaction[]
  notifications   Notification[]

  @@map("User")
  @@index([organizationId])
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  ownerId   String?
  
  users     User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Organization")
}



model SupportAgent {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  assignedTickets SupportTicket[]

  @@map("SupportAgent")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  actorId   String
  actorRole String
  action    String
  entity    String?
  entityId  String?
  metadata  String?  @db.Text
  ipAddress String?
  createdAt DateTime @default(now())

  @@map("ActivityLog")
}

model DoctorProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization      String
  customProfession    String?
  qualifications      String
  licenseNumber       String   @unique
  hospitalAffiliation String?
  yearsOfExperience   Int?
  consultationFee     Float
  availability        String?  @db.Text
  timezone            String   @default("UTC")
  bio                 String?
  languages           String?  @db.Text
  
  emergencyContact      String?  @db.Text
  emergencyContactName  String?
  emergencyContactEmail String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  prescriptions  Prescription[]
  consultations  VideoConsultation[] @relation("DoctorConsultations")
  appointments   Appointment[]       @relation("DoctorAppointments")
  doctorPatients DoctorPatient[]     @relation("DoctorPatient_Doctor")
  schedules      DoctorSchedule[]    @relation("DoctorSchedules")

  encounters     ClinicalEncounter[]
  labOrders      LabOrder[]
  referralsSent  Referral[]          @relation("Referrer")
  referralsRecv  Referral[]          @relation("Referee")



  @@map("DoctorProfile")
}

model PharmacyProfile {
  id            String @id @default(uuid())
  userId        String @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName   String?
  licenseNumber String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  postalCode    String?

  latitude      Float?
  longitude     Float?

  openingHours  String? @db.Text
  services      String? @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  prescriptions Prescription[]
  selectedByPatients SelectedPharmacy[]

  medicines       Medicine[]
  medicineOrders  MedicineOrder[]

  @@map("PharmacyProfile")
}

model PatientProfile {
  id             String     @id @default(uuid())
  userId         String     @unique
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  bloodGroup     BloodGroup
  height         Float?
  heightUnit     String?    @default("cm")
  weight         Float?
  weightUnit     String?    @default("kg")
  allergies      String?    @db.Text
  medications    String?    @db.Text
  medicalHistory String?    @db.Text
  address        String?

  medicalRecordNumber String? @unique
  insuranceProvider   String?
  insuranceMemberId   String?

  emergencyContact      String?  @db.Text
  emergencyContactName  String?
  emergencyContactEmail String?
  
  riskLevel             String?
  chronicConditions     String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  selectedPharmacies SelectedPharmacy[]

  prescriptions Prescription[]
  consultations VideoConsultation[] @relation("PatientConsultations")
  appointments  Appointment[]       @relation("PatientAppointments")
  doctorLinks   DoctorPatient[]     @relation("DoctorPatient_Patient")
  encounters    ClinicalEncounter[]
  labOrders     LabOrder[]
  referrals     Referral[]
  medicineOrders  MedicineOrder[]

  @@map("PatientProfile")
}

model Appointment {
  id              String            @id @default(uuid())
  doctorId        String
  patientId       String
  
  appointmentDate DateTime          // Start time
  startTime       DateTime?         // New explicit start time
  endTime         DateTime?         // New explicit end time
  
  reason          String?
  status          AppointmentStatus @default(PENDING)
  
  chiefComplaint  String?           @db.Text
  intakeNotes     String?           @db.Text
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  roomName        String?
  callStatus      String    @default("idle")

  doctor  DoctorProfile  @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)
  patient PatientProfile @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  encounter ClinicalEncounter?

  @@index([doctorId])
  @@index([patientId])
  @@index([appointmentDate])

  @@map("Appointment")
}

model DoctorSchedule {
  id        String   @id @default(uuid())
  doctorId  String
  dayOfWeek Int      // 0=Sunday, 1=Monday, ...
  startTime String   // "09:00"
  endTime   String   // "17:00"
  
  slotDuration Int      @default(15) // Duration in minutes
  
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  doctor DoctorProfile @relation("DoctorSchedules", fields: [doctorId], references: [id], onDelete: Cascade)
  
  @@index([doctorId])
  @@index([dayOfWeek])
  @@map("DoctorSchedule")
}

model SupportTicket {
  id        Int            @id @default(autoincrement())
  ticketNo  String         @unique @default(uuid())
  userId    String
  user      User           @relation("raisedBy", fields: [userId], references: [id], onDelete: Cascade)
  agentId   Int?
  agent     SupportAgent?  @relation(fields: [agentId], references: [id], onDelete: SetNull)
  subject   String
  body      String         @db.Text
  status    TicketStatus   @default(OPEN)
  priority  Priority       @default(MEDIUM)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  replies   SupportReply[]

  @@map("SupportTicket")
}

model SupportReply {
  id       Int           @id @default(autoincrement())
  ticketId Int
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)



  message   String   @db.Text
  createdAt DateTime @default(now())

  @@map("SupportReply")
}

// Prescription and other models kept as is
model Prescription {
  id            String   @id @default(cuid())
  doctorId      String
  patientId     String
  medication    String
  dosage        String
  frequency     String
  duration      String
  notes         String?
  
  isControlled  Boolean  @default(false)
  deaNumber     String?
  refills       Int      @default(0)
  drugAlerts    String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  pharmacyId     String?
  pharmacy       PharmacyProfile? @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)
  dispatchStatus PrescriptionDispatchStatus @default(NONE)
  dispatchedAt   DateTime?

  doctor  DoctorProfile  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient PatientProfile @relation(fields: [patientId], references: [id], onDelete: Cascade)
  encounterId String?
  encounter   ClinicalEncounter? @relation(fields: [encounterId], references: [id])

  medicineOrders  MedicineOrder[]

  @@index([doctorId])
  @@index([patientId])
  @@index([pharmacyId])

  @@map("Prescription")
}

model ClinicalEncounter {
  id          String   @id @default(uuid())
  appointmentId String @unique
  doctorId    String
  patientId   String
  
  subjective  String?  @db.Text
  objective   String?  @db.Text
  assessment  String?  @db.Text
  plan        String?  @db.Text
  
  systolic    Int?
  diastolic   Int?
  pulse       Int?
  temperature Float?
  weight      Float?
  oxygenSat   Int?
  
  status      EncounterStatus @default(DRAFT)
  signedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointment Appointment    @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  doctor      DoctorProfile  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient     PatientProfile @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescriptions Prescription[]
  labOrders     LabOrder[]
  referrals     Referral[]

  @@map("ClinicalEncounter")
}

model LabOrder {
  id          String   @id @default(uuid())
  doctorId    String
  patientId   String
  encounterId String?
  
  testName    String
  status      LabStatus @default(ORDERED)
  results     String?   @db.Text
  orderedAt   DateTime  @default(now())
  completedAt DateTime?

  doctor      DoctorProfile  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient     PatientProfile @relation(fields: [patientId], references: [id], onDelete: Cascade)
  encounter   ClinicalEncounter? @relation(fields: [encounterId], references: [id])

  @@map("LabOrder")
}

model Referral {
  id          String   @id @default(uuid())
  doctorId    String
  patientId   String
  encounterId String?
  
  targetDoctorId String?
  specialistName String?
  type        ReferralType
  reason      String   @db.Text
  status      String   @default("PENDING")

  doctor      DoctorProfile  @relation("Referrer", fields: [doctorId], references: [id], onDelete: Cascade)
  referee     DoctorProfile? @relation("Referee", fields: [targetDoctorId], references: [id])
  patient     PatientProfile @relation(fields: [patientId], references: [id], onDelete: Cascade)
  encounter   ClinicalEncounter? @relation(fields: [encounterId], references: [id])

  @@map("Referral")
}

model Message {
  id         String    @id @default(cuid())
  senderId   String?
  receiverId String?
  content    String
  createdAt  DateTime  @default(now())
  readAt     DateTime?

  sender   User? @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User? @relation("MessagesRecv", fields: [receiverId], references: [id], onDelete: Cascade)



  @@map("Message")
}

model VideoConsultation {
  id           String             @id @default(uuid())
  doctorId     String
  patientId    String
  title        String?
  notes        String?
  scheduledAt  DateTime
  durationMins Int?
  status       ConsultationStatus @default(SCHEDULED)
  roomName     String?
  meetingUrl   String?
  actualStartTime DateTime?
  actualEndTime   DateTime?
  recordingUrl    String?
  failureReason   String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  doctor  DoctorProfile  @relation("DoctorConsultations", fields: [doctorId], references: [id], onDelete: Cascade)
  patient PatientProfile @relation("PatientConsultations", fields: [patientId], references: [id], onDelete: Cascade)

  videoSession    VideoSession?

  @@index([doctorId])
  @@index([patientId])

  @@map("VideoConsultation")
}

model SubscriptionSetting {
  id                 Int      @id @default(1)
  doctorMonthlyUsd   Float?
  doctorYearlyUsd    Float?
  patientMonthlyUsd  Float?
  patientYearlyUsd   Float?
  pharmacyMonthlyUsd Float?
  pharmacyYearlyUsd  Float?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("SubscriptionSetting")
}

model Subscription {
  id       String   @id @default(uuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     Plan
  status   SubStatus @default(PENDING)

  provider  String?
  reference String?  @unique
  amount    Int?
  currency  String?

  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions    Transaction[]

  @@index([userId])
  @@index([status])
  @@index([plan])

  @@map("Subscription")
}

model DoctorPatient {
  id        String @id @default(uuid())
  doctorId  String
  patientId String

  doctor  DoctorProfile  @relation(name: "DoctorPatient_Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  patient PatientProfile @relation(name: "DoctorPatient_Patient", fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([doctorId, patientId])
  @@index([patientId])
  @@index([doctorId])

  @@map("DoctorPatient")
}

model SelectedPharmacy {
  id           String @id @default(uuid())
  patientId    String
  pharmacyId   String
  preferred    Boolean @default(false)

  patient  PatientProfile  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  pharmacy PharmacyProfile @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())

  @@unique([patientId, pharmacyId])
  @@map("SelectedPharmacy")
}

model SystemSetting {
  id          Int      @id @default(1)
  systemName  String?
  themeColor  String?
  logoUrl     String?
  defaultFee  Float?
  monthlyPlan Float?
  yearlyPlan  Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("SystemSetting")
}
// ============================================
// CUREVIRTUAL V2.0 - NEW SCHEMA ADDITIONS
// ============================================
// This file contains all new models to be added to the main schema.prisma
// Copy these models into your main schema.prisma file

// ============================================
// ENUMS (Add to existing enums section)
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REJECTED
}

enum TransactionType {
  SUBSCRIPTION_PAYMENT
  ORDER_PAYMENT
  CONSULTATION_PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum NotificationType {
  APPOINTMENT
  PRESCRIPTION
  ORDER
  MESSAGE
  PAYMENT
  SYSTEM
}

// ============================================
// PHARMACY INVENTORY MANAGEMENT
// ============================================

model Medicine {
  id            String   @id @default(uuid())
  pharmacyId    String
  pharmacy      PharmacyProfile @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  name          String
  genericName   String?
  category      String   // e.g., "Antibiotic", "Painkiller"
  manufacturer  String?
  description   String?  @db.Text
  
  // Inventory
  stockQuantity Int      @default(0)
  unitPrice     Float    // Price per unit
  currency      String   @default("USD")
  
  // Product Details
  dosageForm    String?  // e.g., "Tablet", "Syrup", "Injection"
  strength      String?  // e.g., "500mg"
  packSize      Int?     // Units per pack
  
  // Availability
  isAvailable   Boolean  @default(true)
  requiresPrescription Boolean @default(true)
  
  // Alerts
  lowStockThreshold Int  @default(10)
  
  // Images
  imageUrl      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  orderItems    MedicineOrderItem[]
  
  @@index([pharmacyId])
  @@index([name])
  @@map("medicine")
}

// ============================================
// MEDICINE ORDERS (Patient â†’ Pharmacy)
// ============================================

model MedicineOrder {
  id              String      @id @default(uuid())
  orderNumber     String      @unique // e.g., "ORD-2025-001"
  
  // Relations
  patientId       String
  patient         PatientProfile @relation(fields: [patientId], references: [id])
  
  pharmacyId      String
  pharmacy        PharmacyProfile @relation(fields: [pharmacyId], references: [id])
  
  prescriptionId  String?     // Optional: linked prescription
  prescription    Prescription? @relation(fields: [prescriptionId], references: [id], onDelete: SetNull)
  
  // Order Details
  status          OrderStatus @default(PENDING)
  items           MedicineOrderItem[]
  
  // Pricing
  subtotal        Float
  deliveryFee     Float       @default(0)
  tax             Float       @default(0)
  discount        Float       @default(0)
  totalAmount     Float
  
  // Payment
  paymentStatus   String      @default("PENDING") // PENDING, PAID, FAILED
  paymentMethod   String?     // e.g., "CARD", "CASH"
  paymentReference String?    @unique
  
  // Delivery
  deliveryAddress String?     @db.Text
  deliveryType    String      @default("PICKUP") // PICKUP, DELIVERY
  estimatedDelivery DateTime?
  
  // Tracking
  notes           String?     @db.Text
  rejectionReason String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?
  
  // Relations
  transactions    Transaction[]
  
  @@index([patientId])
  @@index([pharmacyId])
  @@index([status])
  @@index([orderNumber])
  @@map("medicineorder")
}

model MedicineOrderItem {
  id          String  @id @default(uuid())
  orderId     String
  order       MedicineOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  medicineId  String
  medicine    Medicine @relation(fields: [medicineId], references: [id])
  
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  
  @@index([orderId])
  @@index([medicineId])
  @@map("medicineorderitem")
}

// ============================================
// PAYMENTS & TRANSACTIONS
// ============================================

model Transaction {
  id              String            @id @default(uuid())
  
  // User
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  // Transaction Details
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Float
  currency        String            @default("USD")
  
  // Payment Gateway
  provider        String            // e.g., "STRIPE", "PAYPAL", "MOCK"
  providerTxId    String?           @unique // Stripe payment intent ID
  providerCustomerId String?
  
  // References
  subscriptionId  String?
  subscription    Subscription?     @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  orderId         String?
  order           MedicineOrder?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  // Metadata
  description     String?
  metadata        String?           @db.Text // JSON string
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("transaction")
}

// ============================================
// REAL-TIME NOTIFICATIONS
// ============================================

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String           @db.Text
  
  // Metadata
  link        String?          // URL to navigate
  actionData  String?          @db.Text // JSON metadata
  
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notification")
}

// ============================================
// VIDEO CONSULTATION ENHANCEMENTS
// ============================================

model VideoSession {
  id              String   @id @default(uuid())
  consultationId  String   @unique
  consultation    VideoConsultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  
  // Agora/Twilio Details
  channelName     String   @unique
  token           String?  @db.Text
  uid             String?
  
  // Session State
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int?     // minutes
  
  // Recording (if enabled)
  recordingUrl    String?
  recordingId     String?
  
  @@map("videosession")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model SystemMetric {
  id          String   @id @default(uuid())
  metricType  String   // e.g., "DAILY_REVENUE", "ACTIVE_USERS", "ORDERS_COUNT"
  value       Float
  metadata    String?  @db.Text // JSON
  recordedAt  DateTime @default(now())
  
  @@index([metricType, recordedAt])
  @@map("systemmetric")
}

// ============================================
// RELATION UPDATES FOR EXISTING MODELS
// ============================================
// Add these fields to existing models in your main schema.prisma:

// User model - Add:
//   transactions    Transaction[]
//   notifications   Notification[]

// PharmacyProfile model - Add:
//   medicines       Medicine[]
//   medicineOrders  MedicineOrder[]

// PatientProfile model - Add:
//   medicineOrders  MedicineOrder[]

// Prescription model - Add:
//   medicineOrders  MedicineOrder[]

// Subscription model - Add:
//   transactions    Transaction[]

// VideoConsultation model - Add:
//   videoSession    VideoSession?
